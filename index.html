<!doctype html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Via Cumbres | Security Master</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;600;800&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Plus Jakarta Sans', sans-serif; background-color: #f8fafc; }
        .seccion { display: none; }
        .activo { display: block; animation: fadeIn 0.3s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .glass-nav { background: rgba(255, 255, 255, 0.8); backdrop-filter: blur(12px); border-top: 1px solid rgba(226, 232, 240, 0.8); }
        .input-elegant { @apply w-full p-4 bg-white border border-slate-200 rounded-2xl mb-4 outline-none focus:ring-4 focus:ring-indigo-500/10 focus:border-indigo-500 transition-all font-medium text-slate-700 shadow-sm; }
        .btn-primary { @apply w-full bg-slate-900 text-white p-5 rounded-3xl font-bold text-lg shadow-xl active:scale-[0.98] transition-all disabled:opacity-50; }
        .card-registro { @apply bg-white p-5 rounded-[2.5rem] border border-slate-100 shadow-sm mb-4; }
        #bloqueo { background: #0f172a; z-index: 1000; position: fixed; inset: 0; display: flex; align-items: center; justify-content: center; }
    </style>
</head>
<body class="text-slate-900">

    <div id="bloqueo" class="hidden">
        <div class="w-full max-w-sm text-center p-8">
            <div class="inline-block p-4 bg-indigo-500/10 rounded-3xl mb-6"><span class="text-5xl">üõ°Ô∏è</span></div>
            <h2 class="text-3xl font-extrabold text-white mb-2 tracking-tight italic">VIA CUMBRES</h2>
            <p class="text-slate-400 text-xs font-bold mb-10 uppercase tracking-[0.3em]">Security Control</p>
            <div class="bg-white/5 p-2 rounded-[2.5rem] backdrop-blur-md border border-white/10">
                <input type="password" id="pass" placeholder="CLAVE" class="w-full p-5 bg-transparent border-none text-center text-2xl text-white font-black tracking-widest outline-none">
                <button onclick="verificar()" class="w-full bg-white text-slate-950 p-5 rounded-[2rem] font-black text-lg">ENTRAR</button>
            </div>
        </div>
    </div>

    <div id="app" class="hidden">
        <nav class="fixed bottom-0 left-0 right-0 h-20 glass-nav flex justify-around items-center z-50 px-6">
            <button onclick="navegar('inicio')" class="text-center"><div class="text-2xl">üè†</div><span class="text-[10px] font-extrabold text-slate-400 uppercase">Inicio</span></button>
            <button onclick="navegar('buscar')" class="text-center"><div class="text-2xl">üîç</div><span class="text-[10px] font-extrabold text-slate-400 uppercase">Buscar</span></button>
            <button onclick="navegar('bitacora')" class="text-center"><div class="text-2xl">üìã</div><span class="text-[10px] font-extrabold text-slate-400 uppercase">Hoy</span></button>
        </nav>

        <div id="sec-inicio" class="seccion activo p-8 pt-16">
            <div class="mb-10 text-left">
                <p class="text-indigo-600 font-bold text-xs uppercase tracking-widest mb-1">Bienvenido</p>
                <h1 id="display-nombre" class="text-4xl font-extrabold text-slate-900 tracking-tighter uppercase italic">---</h1>
            </div>
            <div class="grid gap-5">
                <button onclick="abrirForm('ACCESO 1')" class="group relative overflow-hidden bg-slate-900 p-8 rounded-[2.5rem] shadow-2xl text-left"><span class="block text-white text-2xl font-bold relative z-10">Acceso 1</span><span class="text-slate-400 text-xs font-bold uppercase tracking-widest relative z-10 italic">Principal</span><div class="absolute right-[-10px] bottom-[-10px] text-7xl opacity-10">üöó</div></button>
                <button onclick="abrirForm('ACCESO 2')" class="group relative overflow-hidden bg-white border border-slate-100 p-8 rounded-[2.5rem] shadow-sm text-left"><span class="block text-slate-900 text-2xl font-bold relative z-10">Acceso 2</span><span class="text-slate-400 text-xs font-bold uppercase tracking-widest relative z-10 italic">Secundario</span><div class="absolute right-[-10px] bottom-[-10px] text-7xl opacity-5">üöõ</div></button>
                <button onclick="abrirForm('PEATONAL')" class="group relative overflow-hidden bg-indigo-600 p-8 rounded-[2.5rem] shadow-xl text-left"><span class="block text-white text-2xl font-bold relative z-10">Peatonal</span><span class="text-indigo-200 text-xs font-bold uppercase tracking-widest relative z-10 italic">Visitantes</span><div class="absolute right-[-10px] bottom-[-10px] text-7xl opacity-20">üö∂</div></button>
            </div>
            <button onclick="salir()" class="mt-12 w-full text-slate-400 font-bold text-[10px] uppercase tracking-[0.3em]">Cerrar Sesi√≥n</button>
        </div>

        <div id="sec-form" class="seccion p-6 pb-28">
            <div class="flex items-center justify-between mb-8">
                <div class="bg-indigo-50 px-5 py-2 rounded-2xl border border-indigo-100"><span id="tag-lugar" class="text-indigo-700 font-extrabold text-xs uppercase italic"></span></div>
                <button onclick="navegar('inicio')" class="h-10 w-10 flex items-center justify-center bg-white rounded-full text-slate-400">‚úï</button>
            </div>

            <div class="space-y-1">
                <label class="text-[10px] font-bold text-slate-400 uppercase ml-4 tracking-widest">Identificaci√≥n</label>
                <select id="tipo" class="input-elegant"><option>VISITA</option><option>PROVEEDOR</option><option>RESIDENTE</option><option>DOM√âSTICO</option><option>PROPIETARIO</option><option>TRABAJADOR</option></select>
                <input type="text" id="nombre" placeholder="üë§ Nombre Completo" class="input-elegant">
                <input type="text" id="domicilio" placeholder="üè† Casa / Lote / Destino" class="input-elegant">

                <label class="text-[10px] font-bold text-slate-400 uppercase ml-4 tracking-widest">Veh√≠culo</label>
                <div class="grid grid-cols-2 gap-3">
                    <input type="text" id="placa" placeholder="üî¢ Placas" class="input-elegant uppercase">
                    <select id="marca" class="input-elegant">
                        <option value="-">MARCA</option><option>NISSAN</option><option>CHEVROLET</option><option>VOLKSWAGEN</option><option>TOYOTA</option><option>KIA</option><option>MAZDA</option><option>HONDA</option><option>FORD</option><option>HYUNDAI</option><option>BMW</option><option>AUDI</option><option>MERCEDES</option><option>TESLA</option><option>MG</option><option>BYD</option><option>OTRO</option>
                    </select>
                </div>
                <input type="text" id="modelo" placeholder="‚ú® Modelo (Ej: Sentra, Aveo, etc.)" class="input-elegant">

                <label class="text-[10px] font-bold text-slate-400 uppercase ml-4 tracking-widest">Evidencias Fotogr√°ficas</label>
                <div class="grid grid-cols-1 gap-4 mt-2">
                    <button onclick="tomarFoto('ine')" class="w-full p-4 border-2 border-dashed border-slate-200 rounded-2xl bg-white flex items-center justify-between">
                        <div class="flex items-center gap-3"><span class="text-2xl">ü™™</span><div class="text-left"><p class="text-[10px] font-black uppercase text-slate-700">Identificaci√≥n</p><p class="text-[9px] text-slate-400 italic" id="txt-ine">Pendiente...</p></div></div>
                        <img id="prev-ine" class="hidden h-12 w-12 rounded-lg object-cover border">
                    </button>
                    <button onclick="tomarFoto('auto')" class="w-full p-4 border-2 border-dashed border-slate-200 rounded-2xl bg-white flex items-center justify-between">
                        <div class="flex items-center gap-3"><span class="text-2xl">üöó</span><div class="text-left"><p class="text-[10px] font-black uppercase text-slate-700">Veh√≠culo / Placa</p><p class="text-[9px] text-slate-400 italic" id="txt-auto">Pendiente...</p></div></div>
                        <img id="prev-auto" class="hidden h-12 w-12 rounded-lg object-cover border">
                    </button>
                    <button onclick="tomarFoto('extra')" class="w-full p-4 border-2 border-dashed border-slate-200 rounded-2xl bg-white flex items-center justify-between opacity-70">
                        <div class="flex items-center gap-3"><span class="text-2xl">‚ûï</span><div class="text-left"><p class="text-[10px] font-black uppercase text-slate-700">Adicional (Opcional)</p><p class="text-[9px] text-slate-400 italic" id="txt-extra">Ninguna...</p></div></div>
                        <img id="prev-extra" class="hidden h-12 w-12 rounded-lg object-cover border">
                    </button>
                </div>
                <input type="file" id="f-ine" accept="image/*" capture="environment" class="hidden" onchange="procesarFoto(this, 'ine')">
                <input type="file" id="f-auto" accept="image/*" capture="environment" class="hidden" onchange="procesarFoto(this, 'auto')">
                <input type="file" id="f-extra" accept="image/*" capture="environment" class="hidden" onchange="procesarFoto(this, 'extra')">

                <div class="pt-6"><button onclick="guardar()" id="btn-guardar" class="btn-primary">FINALIZAR REGISTRO</button></div>
            </div>
        </div>

        <div id="sec-buscar" class="seccion p-6 pb-28">
            <h2 class="text-3xl font-extrabold text-slate-900 mb-6 tracking-tighter">Buscador</h2>
            <input type="text" id="input-busqueda" onkeyup="ejecutarFiltros()" placeholder="Nombre o placa..." class="input-elegant">
            <div class="grid grid-cols-2 gap-3 mb-6">
                <input type="date" id="filtro-fecha" onchange="ejecutarFiltros()" class="input-elegant !text-xs">
                <select id="filtro-estado" onchange="ejecutarFiltros()" class="input-elegant !text-xs"><option value="TODOS">TODOS</option><option value="ADENTRO">ADENTRO</option><option value="SALIDA">SALIDA</option></select>
            </div>
            <div id="lista-busqueda"></div>
        </div>

        <div id="sec-bitacora" class="seccion p-6 pb-28">
            <h2 class="text-3xl font-extrabold text-slate-900 mb-6 tracking-tighter italic">Hoy</h2>
            <div id="lista-bitacora"></div>
        </div>
    </div>

    <script>
        // CONFIGURACI√ìN CENTRAL
        const CLAVES = { "CUMBRES": "VIA CUMBRES", "ADMIN": "ADMINISTRACI√ìN" };
        const URL_EXCEL = ""; // <--- PEGA TU LINK DE GOOGLE AQU√ç

        const storage = {
            get: (k) => localStorage.getItem(k),
            set: (k, v) => localStorage.setItem(k, v)
        };

        let db = JSON.parse(storage.get('db_seguridad')) || [];
        let fotos = { ine: "", auto: "", extra: "" };
        let lugarActual = "", fraccNombre = "";

        // Al cargar la p√°gina, verificar si ya hay sesi√≥n
        window.onload = () => {
            const sesion = storage.get('sesion_activa');
            if(sesion) entrar(sesion);
            else document.getElementById('bloqueo').classList.remove('hidden');
        };

        function verificar() {
            const p = document.getElementById('pass').value.trim().toUpperCase();
            if(CLAVES[p]) {
                storage.set('sesion_activa', CLAVES[p]);
                entrar(CLAVES[p]);
            } else { alert("Clave Incorrecta"); }
        }

        function entrar(nombre) {
            fraccNombre = nombre;
            document.getElementById('display-nombre').innerText = nombre;
            document.getElementById('bloqueo').classList.add('hidden');
            document.getElementById('app').classList.remove('hidden');
        }

        function navegar(id) {
            document.querySelectorAll('.seccion').forEach(s => s.classList.remove('activo'));
            document.getElementById('sec-' + id).classList.add('activo');
            if(id === 'bitacora' || id === 'buscar') ejecutarFiltros();
            window.scrollTo(0,0);
        }

        function abrirForm(lugar) {
            lugarActual = lugar;
            document.getElementById('tag-lugar').innerText = "üìç " + lugar;
            navegar('form');
        }

        function tomarFoto(tipo) { document.getElementById('f-' + tipo).click(); }

        function procesarFoto(input, tipo) {
            if (input.files && input.files[0]) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    fotos[tipo] = e.target.result;
                    document.getElementById('prev-' + tipo).src = e.target.result;
                    document.getElementById('prev-' + tipo).classList.remove('hidden');
                    document.getElementById('txt-' + tipo).innerText = "‚úÖ Capturada";
                    document.getElementById('txt-' + tipo).classList.replace('text-slate-400', 'text-emerald-500');
                };
                reader.readAsDataURL(input.files[0]);
            }
        }

        function guardar() {
            const btn = document.getElementById('btn-guardar');
            const reg = {
                id: Date.now(),
                fracc: fraccNombre,
                nombre: document.getElementById('nombre').value.trim(),
                domicilio: document.getElementById('domicilio').value.trim(),
                tipo: document.getElementById('tipo').value,
                placa: document.getElementById('placa').value.toUpperCase().trim() || "S/P",
                marca: document.getElementById('marca').value,
                modelo: document.getElementById('modelo').value.trim() || "-",
                fotoIne: fotos.ine,
                fotoAuto: fotos.auto,
                fotoExtra: fotos.extra,
                horaEntrada: new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'}),
                fecha: new Date().toLocaleDateString('es-MX'),
                lugar: lugarActual,
                estado: 'ADENTRO'
            };

            if(!reg.nombre || !reg.domicilio) return alert("‚ö†Ô∏è Nombre y Destino son obligatorios");
            if(!reg.fotoIne || !reg.fotoAuto) return alert("‚ö†Ô∏è Toma foto de Identificaci√≥n y Veh√≠culo");
            
            btn.disabled = true; btn.innerText = "REGISTRANDO...";
            db.unshift(reg);
            storage.set('db_seguridad', JSON.stringify(db));

            if(URL_EXCEL) { fetch(URL_EXCEL, { method: 'POST', mode: 'no-cors', body: JSON.stringify(reg) }); }
            setTimeout(() => { alert("‚úÖ ACCESO REGISTRADO"); location.reload(); }, 800);
        }

        function ejecutarFiltros() {
            const query = (document.getElementById('input-busqueda')?.value || "").toLowerCase();
            const f_fecha = document.getElementById('filtro-fecha')?.value;
            const f_estado = document.getElementById('filtro-estado')?.value || "TODOS";
            
            const render = (containerId, filterFn) => {
                const c = document.getElementById(containerId);
                if(!c) return;
                c.innerHTML = "";
                db.filter(filterFn).forEach(r => {
                    const color = r.estado === 'ADENTRO' ? 'bg-emerald-500' : 'bg-slate-300';
                    c.innerHTML += `
                        <div class="card-registro">
                            <div class="flex justify-between mb-4">
                                <div>
                                    <div class="flex items-center gap-2 mb-1"><div class="w-2 h-2 rounded-full ${color}"></div><span class="text-[9px] font-black text-slate-400 uppercase italic">${r.tipo}</span></div>
                                    <h4 class="text-lg font-bold text-slate-900">${r.nombre}</h4>
                                    <p class="text-xs font-medium text-slate-500">${r.domicilio} ‚Ä¢ <span class="text-indigo-500">${r.fecha}</span></p>
                                </div>
                                <div class="text-right"><p class="text-xs font-black text-slate-900">${r.horaEntrada}</p><p class="text-[9px] font-bold text-slate-400 uppercase">${r.estado}</p></div>
                            </div>
                            <div class="flex gap-2">
                                <button onclick='verFicha(${JSON.stringify(r)})' class="flex-1 bg-slate-50 py-3 rounded-xl text-[10px] font-black border border-slate-100 uppercase">Ver Ficha</button>
                                ${r.estado === 'ADENTRO' ? `<button onclick="darSalida(${r.id})" class="flex-1 bg-rose-50 text-rose-600 py-3 rounded-xl text-[10px] font-black border border-rose-100 uppercase">Salida</button>` : ''}
                            </div>
                        </div>`;
                });
            };

            const hoy = new Date().toLocaleDateString('es-MX');
            render('lista-bitacora', r => r.fecha === hoy);
            render('lista-busqueda', r => {
                const mTexto = r.nombre.toLowerCase().includes(query) || r.placa.toLowerCase().includes(query);
                const p = r.fecha.split('/'); const fISO = `${p[2]}-${p[1].padStart(2,'0')}-${p[0].padStart(2,'0')}`;
                const mFecha = !f_fecha || fISO === f_fecha;
                const mEstado = f_estado === "TODOS" || r.estado === f_estado;
                return mTexto && mFecha && mEstado;
            });
        }

        function darSalida(id) {
            const i = db.findIndex(r => r.id === id);
            if(i !== -1) {
                db[i].estado = 'SALIDA';
                db[i].horaSalida = new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
                storage.set('db_seguridad', JSON.stringify(db));
                ejecutarFiltros();
            }
        }

        function salir() { if(confirm("¬øCerrar sesi√≥n?")) { storage.set('sesion_activa', ''); location.reload(); } }

        function verFicha(r) {
            const v = window.open('', '_blank');
            v.document.write(`<html><head><title>Ficha</title><style>
                body { font-family: sans-serif; padding: 20px; text-align: center; background:#f8fafc; }
                .c { background:white; border-radius: 30px; padding: 30px; max-width: 450px; margin: auto; box-shadow:0 10px 25px rgba(0,0,0,0.05); }
                .grid-fotos { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin: 20px 0; }
                img { width: 100%; border-radius: 15px; border: 2px solid #f1f5f9; height: 120px; object-fit: cover; }
                .foto-full { height: 200px; grid-column: span 2; }
                .d { display: flex; justify-content: space-between; padding: 12px; border-bottom: 1px solid #f1f5f9; font-size: 14px; }
            </style></head><body>
                <div class="c">
                    <h2 style="margin:0">${r.fracc}</h2>
                    <p style="font-size:10px; font-weight:900; color:indigo; letter-spacing:2px; margin-bottom:20px;">REPORTE DE ACCESO</p>
                    <div class="grid-fotos">
                        <img src="${r.fotoIne}" class="foto-full" onerror="this.style.display='none'">
                        <img src="${r.fotoAuto}" onerror="this.style.display='none'">
                        <img src="${r.fotoExtra || ''}" onerror="this.style.display='none'">
                    </div>
                    <div class="d"><b>Nombre:</b> <span>${r.nombre}</span></div>
                    <div class="d"><b>Destino:</b> <span>${r.domicilio}</span></div>
                    <div class="d"><b>Veh√≠culo:</b> <span>${r.marca} ${r.modelo}</span></div>
                    <div class="d"><b>Placas:</b> <span>${r.placa}</span></div>
                    <div class="d"><b>Ingreso:</b> <span>${r.fecha} ${r.horaEntrada}</span></div>
                    ${r.horaSalida ? `<div class="d"><b>Salida:</b> <span style="color:#ef4444">${r.horaSalida}</span></div>` : ''}
                    <button onclick="window.print()" style="margin-top:30px; width:100%; padding:20px; border-radius:20px; background:#0f172a; color:white; font-weight:bold; border:none;">IMPRIMIR / PDF</button>
                </div>
            </body></html>`);
            v.document.close();
        }
    </script>
</body>
</html>