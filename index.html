<!doctype html>
<html lang="es">
 <head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>Ingresos Via Cumbres</title>
  
  <script src="./_sdk/data_sdk.js"></script>
  <script src="./_sdk/element_sdk.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  
  <style>
    body { font-family: sans-serif; background-color: #f8fafc; color: #1e293b; margin: 0; }
    .seccion { display: none; padding: 20px; }
    .visible { display: block !important; }
    .btn-punto { background: #8b5cf6; color: white; width: 100%; padding: 22px; margin-bottom: 15px; border-radius: 16px; font-size: 18px; font-weight: bold; border: none; box-shadow: 0 4px 12px rgba(139, 92, 246, 0.2); }
    .input-box { width: 100%; padding: 15px; margin-bottom: 12px; border: 2px solid #e2e8f0; border-radius: 12px; font-size: 16px; box-sizing: border-box; }
    .btn-verde { background: #10b981; color: white; width: 100%; padding: 20px; border-radius: 12px; font-size: 18px; font-weight: bold; border: none; }
  </style>
 </head>
 <body>

  <div id="pantalla-inicio" class="seccion visible">
    <div style="text-align: center; margin-bottom: 40px; margin-top: 30px;">
        <h1 style="font-size: 28px; font-weight: 800; margin-bottom: 0;">INGRESOS</h1>
        <h2 style="color: #8b5cf6; font-weight: 800; margin-top: 0;">VIA CUMBRES</h2>
    </div>
    <button onclick="seleccionar('Acceso 1')" class="btn-punto">ACCESO 1</button>
    <button onclick="seleccionar('Acceso 2')" class="btn-punto">ACCESO 2</button>
    <button onclick="seleccionar('Peatonal')" class="btn-punto">PEATONAL</button>
  </div>

  <div id="pantalla-form" class="seccion">
    <div style="display: flex; justify-content: space-between; margin-bottom: 20px;">
        <span id="tag-lugar" style="background: #f5f3ff; color: #7c3aed; padding: 5px 12px; border-radius: 20px; font-weight: bold; font-size: 12px; border: 1px solid #ddd6fe;"></span>
        <button onclick="location.reload()" style="color: #94a3b8; font-size: 12px; background:none; border:none; text-decoration:underline;">Cambiar</button>
    </div>

    <form id="formularioIngreso" onsubmit="registrar(event)">
        <select id="tipo" class="input-box" required>
            <option value="">Â¿QUIÃ‰N INGRESA?</option>
            <option value="Propietario">PROPIETARIO</option>
            <option value="Residente">RESIDENTE</option>
            <option value="Visita">VISITA / PROVEEDOR</option>
        </select>
        <input type="text" id="nombre" placeholder="Nombre Completo" class="input-box" required>
        <input type="text" id="domicilio" placeholder="Casa / Depto" class="input-box" required>
        <input type="text" id="placa" placeholder="Placas (Opcional)" class="input-box" style="text-transform: uppercase;">
        
        <div style="background: white; padding: 15px; border-radius: 12px; border: 2px solid #e2e8f0; margin-bottom: 15px;">
            <p style="font-size: 11px; font-weight: bold; color: #94a3b8; margin-bottom: 8px;">FOTO DE EVIDENCIA:</p>
            <input type="file" id="foto" accept="image/*" capture="environment" style="width: 100%; font-size: 14px;">
        </div>

        <button type="submit" id="btn-save" class="btn-verde">CONFIRMAR REGISTRO</button>
    </form>
  </div>

  <script>
    // CORRECCIÃ“N CRÃTICA DE INICIALIZACIÃ“N
    let puntoSeleccionado = "";
    
    // FunciÃ³n de inicializaciÃ³n forzada
    async function inicializarSDK() {
        if (window.dataSdk) {
            try {
                await window.dataSdk.init();
                console.log("Base de datos conectada");
            } catch (e) {
                console.error("Error al conectar DB:", e);
            }
        }
    }

    function seleccionar(lugar) {
        puntoSeleccionado = lugar;
        document.getElementById('pantalla-inicio').classList.remove('visible');
        document.getElementById('pantalla-form').classList.add('visible');
        document.getElementById('tag-lugar').innerText = "ðŸ“ " + lugar;
        // Inicializamos justo al seleccionar el punto
        inicializarSDK();
    }

    async function registrar(e) {
        e.preventDefault();
        
        // VerificaciÃ³n de seguridad reforzada
        if (typeof window.dataSdk === 'undefined' || !window.dataSdk.create) {
            alert("El motor de base de datos no ha cargado. Por favor, revisa tu conexiÃ³n y refresca la pÃ¡gina.");
            return;
        }

        const btn = document.getElementById('btn-save');
        btn.innerText = "GUARDANDO...";
        btn.disabled = true;

        try {
            const fotoFile = document.getElementById('foto').files[0];
            let b64 = "";

            if (fotoFile) {
                b64 = await new Promise((resolve) => {
                    const reader = new FileReader();
                    reader.onload = () => resolve(reader.result);
                    reader.readAsDataURL(fotoFile);
                });
            }

            const registro = {
                acceso: puntoSeleccionado,
                tipo: document.getElementById('tipo').value,
                nombre: document.getElementById('nombre').value,
                domicilio: document.getElementById('domicilio').value,
                placa: document.getElementById('placa').value.toUpperCase() || "N/A",
                foto: b64,
                fecha: new Date().toISOString()
            };

            const respuesta = await window.dataSdk.create(registro);
            if (respuesta.isOk) {
                alert("âœ… REGISTRO GUARDADO EN VIA CUMBRES");
                document.getElementById('formularioIngreso').reset();
                location.reload();
            } else {
                alert("Hubo un problema al guardar: " + respuesta.error);
            }
        } catch (err) {
            alert("Error de sistema: " + err.message);
        } finally {
            btn.innerText = "CONFIRMAR REGISTRO";
            btn.disabled = false;
        }
    }
  </script>
 </body>
</html>
