<!doctype html>
<html lang="es">
 <head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>Sistema de Seguridad Pro</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    .glass { background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(10px); }
    .seccion { display: none; }
    .activo { display: block; }
    .input-v { @apply w-full p-3 bg-slate-50 border-2 border-slate-100 rounded-xl mb-3 outline-none focus:border-purple-500 font-semibold; }
  </style>
 </head>
 <body class="bg-slate-100 font-sans min-h-screen">

  <nav class="fixed bottom-0 left-0 right-0 bg-white border-t border-slate-200 flex justify-around p-3 z-50 glass">
    <button onclick="navegar('inicio')" class="text-center group">
        <div class="text-xl">üè†</div>
        <span class="text-[10px] font-bold text-slate-400">INICIO</span>
    </button>
    <button onclick="navegar('buscar')" class="text-center group">
        <div class="text-xl">üîç</div>
        <span class="text-[10px] font-bold text-slate-400">BUSCAR</span>
    </button>
    <button onclick="navegar('bitacora')" class="text-center group">
        <div class="text-xl">üìã</div>
        <span class="text-[10px] font-bold text-slate-400">BIT√ÅCORA</span>
    </button>
  </nav>

  <div id="sec-inicio" class="seccion activo p-8 text-center min-h-screen flex flex-col justify-center pb-24">
    <div class="mb-8 cursor-pointer" onclick="editarTitulo()">
        <h1 id="txt-titulo-principal" class="text-3xl font-black text-slate-900 italic uppercase">VIA CUMBRES</h1>
        <p class="text-purple-600 font-bold text-xs tracking-widest uppercase">Tap para editar nombre ‚öôÔ∏è</p>
    </div>
    <div class="space-y-3">
        <button onclick="abrirForm('ACCESO 1')" class="w-full bg-purple-600 text-white p-5 rounded-2xl font-black shadow-lg">ACCESO 1</button>
        <button onclick="abrirForm('ACCESO 2')" class="w-full bg-purple-600 text-white p-5 rounded-2xl font-black shadow-lg">ACCESO 2</button>
        <button onclick="abrirForm('PEATONAL')" class="w-full bg-slate-800 text-white p-5 rounded-2xl font-black shadow-lg">PEATONAL</button>
    </div>
  </div>

  <div id="sec-form" class="seccion p-6 pb-24">
    <div class="flex justify-between items-center mb-4">
        <h3 id="form-lugar" class="font-black text-purple-700 bg-purple-100 px-3 py-1 rounded-lg text-sm"></h3>
        <button onclick="navegar('inicio')" class="text-xs font-bold text-slate-400 uppercase">Volver</button>
    </div>

    <div class="bg-white p-5 rounded-[2rem] shadow-xl border border-white">
        <select id="tipo" class="input-v"><option>VISITA</option><option>PROVEEDOR</option><option>RESIDENTE</option></select>
        <input type="text" id="nombre" placeholder="Nombre completo" class="input-v">
        <input type="text" id="domicilio" placeholder="Casa / Lote" class="input-v">

        <div class="grid grid-cols-2 gap-2">
            <input type="text" id="placa" placeholder="Placas" class="input-v uppercase">
            <input type="text" id="marca" placeholder="Marca" class="input-v">
            <input type="text" id="modelo" placeholder="Modelo" class="input-v">
            <input type="text" id="color" placeholder="Color" class="input-v">
        </div>

        <div class="bg-slate-50 p-4 rounded-xl border-2 border-dashed border-slate-200 mb-6 text-center">
            <input type="file" id="foto" accept="image/*" capture="environment" class="hidden" onchange="previewFoto(this)">
            <button onclick="document.getElementById('foto').click()" id="btn-foto" class="text-xs font-black text-purple-600 uppercase">üì∏ Tomar Foto Evidencia</button>
            <img id="img-preview" class="hidden mt-2 w-full rounded-lg border">
        </div>

        <button onclick="guardarRegistro()" id="btn-save" class="w-full bg-emerald-500 text-white py-5 rounded-2xl font-black text-lg shadow-lg shadow-emerald-200">CONFIRMAR REGISTRO</button>
    </div>
  </div>

  <div id="sec-buscar" class="seccion p-6 pb-24">
    <h2 class="text-2xl font-black mb-4">Buscador R√°pido</h2>
    <input type="text" id="input-busqueda" onkeyup="filtrarRegistros()" placeholder="Buscar por Nombre o Placa..." class="input-v mb-4 border-purple-200">
    <div id="lista-busqueda" class="space-y-3"></div>
  </div>

  <div id="sec-bitacora" class="seccion p-6 pb-24">
    <div class="flex justify-between items-center mb-6">
        <h2 class="text-2xl font-black uppercase">Bit√°cora Hoy</h2>
    </div>
    <div id="lista-bitacora" class="space-y-3"></div>
  </div>

  <script>
    // CONFIGURACI√ìN INICIAL
    const URL_EXCEL = "TU_URL_DE_GOOGLE_APPS_SCRIPT_AQUI"; 
    let nombreFracc = localStorage.getItem('nombre_fracc') || "VIA CUMBRES";
    let db = JSON.parse(localStorage.getItem('viaCumbres_DB')) || [];
    let fotoBase64 = "";

    document.getElementById('txt-titulo-principal').innerText = nombreFracc;

    function editarTitulo() {
        let n = prompt("Nombre del Fraccionamiento:", nombreFracc);
        if(n) {
            nombreFracc = n.toUpperCase();
            localStorage.setItem('nombre_fracc', nombreFracc);
            document.getElementById('txt-titulo-principal').innerText = nombreFracc;
        }
    }

    function navegar(id) {
        document.querySelectorAll('.seccion').forEach(s => s.classList.remove('activo'));
        document.getElementById('sec-' + id).classList.add('activo');
        if(id === 'bitacora' || id === 'buscar') actualizarListas();
    }

    function abrirForm(lugar) {
        puntoActual = lugar;
        document.getElementById('form-lugar').innerText = "üìç " + lugar;
        navegar('form');
    }

    function previewFoto(input) {
        if (input.files && input.files[0]) {
            const reader = new FileReader();
            reader.onload = function(e) {
                fotoBase64 = e.target.result;
                const img = document.getElementById('img-preview');
                img.src = fotoBase64;
                img.classList.remove('hidden');
                document.getElementById('btn-foto').innerText = "‚úÖ FOTO CAPTURADA";
            }
            reader.readAsDataURL(input.files[0]);
        }
    }

    async function guardarRegistro() {
        const btn = document.getElementById('btn-save');
        const r = {
            id: Date.now(),
            punto: puntoActual,
            tipo: document.getElementById('tipo').value,
            nombre: document.getElementById('nombre').value,
            domicilio: document.getElementById('domicilio').value,
            placa: document.getElementById('placa').value.toUpperCase() || "S/P",
            marca: document.getElementById('marca').value || "-",
            modelo: document.getElementById('modelo').value || "-",
            color: document.getElementById('color').value || "-",
            foto: fotoBase64,
            fecha: new Date().toLocaleDateString(),
            hora: new Date().toLocaleTimeString(),
            status: 'ADENTRO'
        };

        if(!r.nombre || !r.domicilio) return alert("Llena Nombre y Domicilio");
        
        btn.innerText = "ENVIANDO...";
        btn.disabled = true;

        db.unshift(r);
        localStorage.setItem('viaCumbres_DB', JSON.stringify(db));

        // Env√≠o a Excel (Opcional)
        try {
            if(URL_EXCEL.includes("https")) {
                fetch(URL_EXCEL, { method: 'POST', mode: 'no-cors', body: JSON.stringify(r) });
            }
        } catch(e) {}

        alert("‚úÖ REGISTRO GUARDADO");
        location.reload();
    }

    function actualizarListas() {
        const bita = document.getElementById('lista-bitacora');
        bita.innerHTML = "";
        db.forEach(r => {
            bita.innerHTML += `
                <div class="bg-white p-4 rounded-2xl shadow-sm border border-slate-200">
                    <div class="flex justify-between">
                        <div>
                            <p class="text-[10px] font-bold text-purple-600 uppercase">${r.tipo} | ${r.punto}</p>
                            <h4 class="font-bold text-slate-800">${r.nombre}</h4>
                            <p class="text-xs text-slate-500 italic">Casa: ${r.domicilio}</p>
                        </div>
                        <button onclick='generarFicha(${JSON.stringify(r)})' class="bg-slate-100 p-2 rounded-lg text-[10px] font-black uppercase">Ficha PDF</button>
                    </div>
                </div>`;
        });
    }

    function generarFicha(r) {
        const v = window.open('', '_blank');
        v.document.write(`
            <html>
            <head>
                <style>
                    body { font-family: sans-serif; padding: 40px; background: #f0f0f0; }
                    .card { background: white; max-width: 700px; margin: auto; padding: 30px; border-radius: 15px; border-top: 10px solid #4c1d95; }
                    .header { text-align: center; border-bottom: 2px solid #eee; margin-bottom: 20px; padding-bottom: 10px; }
                    .content { display: flex; gap: 20px; }
                    .data { flex: 1; }
                    .photo { flex: 1; text-align: right; }
                    .photo img { width: 100%; border-radius: 10px; border: 2px solid #ddd; }
                    .field { margin-bottom: 15px; background: #f9f9f9; padding: 10px; border-radius: 8px; }
                    .label { font-size: 10px; color: #888; font-weight: bold; text-transform: uppercase; }
                    .val { font-size: 16px; font-weight: bold; color: #333; }
                    .footer { display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; background: #1e293b; color: white; padding: 15px; border-radius: 10px; margin-top: 20px; }
                </style>
            </head>
            <body>
                <div class="card">
                    <div class="header">
                        <h1 style="margin:0">${nombreFracc}</h1>
                        <p style="margin:0; font-size:12px; color:#666;">FICHA DE ACCESO INDIVIDUAL</p>
                    </div>
                    <div class="content">
                        <div class="data">
                            <div class="field"><span class="label">Visitante</span><br><span class="val">${r.nombre}</span></div>
                            <div class="field"><span class="label">Domicilio</span><br><span class="val">${r.domicilio}</span></div>
                            <div class="field"><span class="label">Entrada</span><br><span class="val">${r.fecha} - ${r.hora}</span></div>
                        </div>
                        <div class="photo">
                            <span class="label">Evidencia</span><br>
                            <img src="${r.foto || 'https://via.placeholder.com/300x200?text=Sin+Foto'}">
                        </div>
                    </div>
                    <div class="footer">
                        <div><small>PLACAS</small><br><b>${r.placa}</b></div>
                        <div><small>MARCA</small><br><b>${r.marca}</b></div>
                        <div><small>MODELO</small><br><b>${r.modelo}</b></div>
                        <div><small>COLOR</small><br><b>${r.color}</b></div>
                    </div>
                    <button onclick="window.print()" style="width:100%; margin-top:20px; padding:15px; background:#10b981; color:white; border:none; border-radius:10px; font-weight:bold;">IMPRIMIR PDF</button>
                </div>
            </body>
            </html>
        `);
        v.document.close();
    }
    
    function filtrarRegistros() {
        const q = document.getElementById('input-busqueda').value.toLowerCase();
        actualizarListas(); // En esta versi√≥n simplificada, podr√≠as filtrar el array db directamente.
    }
  </script>
 </body>
</html>
